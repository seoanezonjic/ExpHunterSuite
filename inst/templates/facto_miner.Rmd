



### **Principal Component Analysis**
This is a PCA plot of the count values normalized following the default method and then they are scaled:

#### **Inertia plot exploring variance explained by dimensions**
```{r, echo = FALSE, warning =FALSE, message=FALSE, results = 'asis', fig.width = 5, fig.height = 4 }
inertia <- as.data.frame(pca_data$eig)[,c(2,3)]
inertia$names <- factor(gsub("comp ", "PC", rownames(inertia)), levels= gsub("comp ", "PC", rownames(inertia)))
colnames(inertia) <- c("var", "cum_var", "names")
inertia$sig <- ifelse(rownames(inertia) %in% paste("comp", seq(1, dim_to_keep)), "significant", "no_significant")
ggplot2::ggplot(inertia) + ggplot2::geom_bar(ggplot2::aes(x = names, y = var, fill = sig), stat = "identity") + 
ggplot2::geom_line(ggplot2::aes(x = names, y = cum_var), stat = "identity", group = 1)+ 
ggplot2::labs(x = "", y = "Percentage of total variance")+ 
ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis(~./100, name = "Cumulative percentage of variance", labels = scales::percent)) + 
ggplot2::theme(legend.position = "bottom", axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))




```


#### **Comparison of significant dimensions significant dimensions**
```{r, echo = FALSE,warning =FALSE, message=FALSE, results = 'asis', fig.width = 8, fig.height = 8  }

dims <- as.data.frame(pca_data$ind$coord)
colnames(dims) <- gsub("Dim.", "PC", colnames(dims))
inertia$text <- paste(inertia$names, "\n(", round(inertia$var, 2),"%)", sep = "")
colnames(dims)[colnames(dims) %in% inertia$names] <- inertia$text[match(colnames(dims), inertia$names)]
dims$names <- rownames(dims)
rownames(dims) <- NULL
dims <- merge(dims, target[,c("sample","treat")], by.x = "names", by.y ="sample")

pca_scatter <- function(data, mapping,...){
	 p <- ggplot2::ggplot(data, mapping)  
	 p$mapping$alpha <- NULL
	 p$mapping$color <- p$mapping$fill
	p + ggplot2::geom_point() + 
	ggplot2::geom_vline(xintercept = 0,  linetype="dashed")+ 
	ggplot2::geom_hline(yintercept = 0,  linetype="dashed")
}

p <- GGally::ggpairs(dims, columns = seq(2, dim_to_keep +1),  mapping = ggplot2::aes(fill = treat, alpha = 0.5),lower = list(continuous = pca_scatter),upper = list(continuous = "blank"), switch = "both") + ggplot2::theme_bw()
p[dim_to_keep, dim_to_keep] <- p[dim_to_keep, dim_to_keep] +ggplot2::coord_flip()
p
```

#### **Representation of the samples in the two first dimension of PCA** 
```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'} 
FactoMineR::plot.PCA(pca_data, invisible = "quali" , title = "")
``` 

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'} 
FactoMineR::plot.PCA(pca_data, invisible = "quali" , title = "", label = "none", habillage = "treat")
```

#### **Representation of the samples and the categories of qualitative valiables in the two first dimension of PCA** 

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'} 

FactoMineR::plot.PCA(pca_data, title = "")
```

#### **Representation of the variable contribution to the PCA axis 1 and 2**

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis', eval = !is.null(numeric_factors)} 
factoextra::fviz_pca_var(pca_data, axes = c(1, 2),select.var = list(name=numeric_factors), col.var="steelblue", title="") +
		ggplot2::theme_minimal()

``` 

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis', eval = (dim_to_keep > 3 & !is.null(numeric_factors)) } 
cat("#### **Representation of the variable contribution to the PCA axis 3 and 4**")

factoextra::fviz_pca_var(pca_data, axes = c(3, 4),select.var = list(name=numeric_factors), col.var="steelblue", title="") +
		ggplot2::theme_minimal()

``` 


```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis', eval = !is.null(numeric_factors)} 
cat("#### **Representation of the individuals and the variable contribution to the PCA axis 1 and 2**")
factoextra::fviz_pca_biplot(pca_data, repel = TRUE,select.var = list(name=numeric_factors), col.var="steelblue", title="") +
		ggplot2::theme_minimal()

```

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'}
cat(paste("#### **Hierarchical clustering of individuals using first", dim_to_keep, "significant PCA dimensions**",sep=' '))
res.hcpc <- FactoMineR::HCPC(pca_data, graph = FALSE)
plot(res.hcpc , choice="tree", title="")

```

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'}
cat(paste("#### **PCA representation of 1 and 2 axis with individuals coloured by its cluster membership. The first ", dim_to_keep, "significant PCA dimensions are used for HCPC**",sep=' '))
plot(res.hcpc , axes=c(1,2), choice="map", draw.tree= FALSE, title="")
```


```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'}
dim_data_quant <- dim_data_merged$quantitative
dim_data_quant <- dim_data_quant[dim_data_quant$factor %in% numeric_factors,]
if (nrow(dim_data_quant) >0 ) {
	cat("#### **Representation of correlation and P value of numeric factors and PCA dimensions**")
	dim_data_quant$p.value <-formatC(dim_data_quant$p.value, format = "e", digits = 2)
	dim_data_quant$correlation <- round(dim_data_quant$correlation, digits = 4)
	dim_data_quant$text_corr <- paste(as.character(dim_data_quant$correlation),as.character(dim_data_quant$p.value), sep = "\n")
	gg_heatmap(dim_data_quant, x_axis="dimension", y_axis="factor",fill = "correlation", text_plot="text_corr")

}
```

```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'}

dim_data_qual <- dim_data_merged$qualitative
if (nrow(dim_data_qual) >0 ) {
	cat("#### **Representation of R2 and P value of qualitative factors and PCA dimensions**")
	dim_data_qual$p.value <- formatC(dim_data_qual$p.value, format = "e", digits = 2)
	dim_data_qual$correlation <- round(dim_data_qual$R2, digits = 4)
	dim_data_qual$text_adjust <- paste(as.character(dim_data_qual$R2),as.character(dim_data_qual$p.value), sep = "\n")
	gg_heatmap(dim_data_qual, x_axis="dimension", y_axis="factor",fill = "R2", text_plot="text_adjust")

}
```



```{r , echo = FALSE, warning =FALSE, message=FALSE, results = 'asis'}

dim_data_cat <- dim_data_merged$qual_category
if (nrow(dim_data_cat) >0 ) {
	cat("#### **Representation of estimated coordinated from barycentre and P value of qualitative factors and PCA dimensions**")
	dim_data_cat$p.value <- formatC(dim_data_cat$p.value, format = "e", digits = 2)
	dim_data_cat$text_estimate <- paste(as.character(dim_data_cat$Estimate),as.character(dim_data_cat$p.value), sep = "\n")
	gg_heatmap(dim_data_cat, x_axis="dimension", y_axis="factor",fill = "Estimate", text_plot="text_estimate")

}
```